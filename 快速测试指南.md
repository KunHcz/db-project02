# 快速测试指南

## 1. 启动系统

```bash
# 方式1: 使用启动脚本
./start.sh

# 方式2: 使用Docker Compose
docker-compose up -d
```

## 2. 验证服务状态

```bash
# 检查容器状态
docker-compose ps

# 检查MongoDB日志
docker logs smart_home_mongodb

# 检查后端日志
docker logs smart_home_backend
```

## 3. 测试API接口

### 健康检查
```bash
curl http://localhost:5000/api/health
```

预期响应：
```json
{
  "status": "ok",
  "database": "smart_home",
  "mongodb_host": "mongodb",
  "mongodb_port": 27017
}
```

### 获取设备列表
```bash
curl http://localhost:5000/api/devices
```

### 获取日志列表
```bash
curl http://localhost:5000/api/logs?page=1&per_page=10
```

## 4. 导入示例数据

```bash
# 进入后端容器
docker exec -it smart_home_backend bash

# 运行导入脚本
cd /app
python ../scripts/import_data.py

# 输入 'y' 清空现有数据（可选）
```

或者从宿主机运行（需要安装pymongo）：
```bash
cd code/scripts
python import_data.py
```

## 5. 测试前端页面

1. 打开浏览器访问: http://localhost:5000
2. 测试设备管理功能：
   - 查看设备列表
   - 添加新设备
   - 编辑设备信息
   - 删除设备
   - 使用地理位置查询附近设备
   - 查看设备统计信息

3. 切换到日志查询页面：
   - 查看日志列表
   - 使用筛选条件查询日志
   - 使用全文搜索
   - 查看统计图表
   - 添加新日志

## 6. 测试MongoDB特色功能

### 测试地理位置查询
```bash
# 查询附近设备（广州市中心附近）
curl "http://localhost:5000/api/devices/nearby?longitude=113.2644&latitude=23.1291&max_distance=5000"
```

### 测试聚合查询
```bash
# 获取日志统计
curl http://localhost:5000/api/logs/stats

# 获取设备统计
curl http://localhost:5000/api/devices/stats
```

### 测试全文搜索
```bash
curl "http://localhost:5000/api/logs/search?keyword=设备"
```

## 7. 验证索引

进入MongoDB容器：
```bash
docker exec -it smart_home_mongodb mongosh -u admin -p admin123 --authenticationDatabase admin

# 切换到smart_home数据库
use smart_home

# 查看devices集合索引
db.devices.getIndexes()

# 查看device_logs集合索引
db.device_logs.getIndexes()

# 应该看到：
# - location: 2dsphere索引
# - timestamp: TTL索引
# - 复合索引
# - 文本索引
```

## 8. 测试数据备份

```bash
cd code/scripts

# 创建备份
python backup_db.py backup

# 列出所有备份
python backup_db.py list

# 恢复备份（示例）
python backup_db.py restore smart_home_backup_20240101_120000
```

## 9. 常见问题排查

### 问题1: 无法访问前端页面
- 检查后端服务是否运行: `docker ps`
- 检查端口5000是否被占用
- 查看后端日志: `docker logs smart_home_backend`

### 问题2: MongoDB连接失败
- 检查MongoDB容器是否运行: `docker ps`
- 检查MongoDB日志: `docker logs smart_home_mongodb`
- 验证连接字符串中的用户名密码

### 问题3: 地理位置查询不工作
- 确保设备数据中的location字段格式正确
- 验证2dsphere索引已创建: `db.devices.getIndexes()`
- 检查经纬度值是否在有效范围内

### 问题4: TTL索引不生效
- TTL索引需要MongoDB后台任务运行
- 通常每分钟检查一次，可能需要等待几分钟
- 可以手动测试: `db.device_logs.find({timestamp: {$lt: new Date(Date.now() - 90*24*60*60*1000)}})`

## 10. 性能测试

### 测试多客户端并发访问
```bash
# 使用ab工具测试（需要安装apache2-utils）
ab -n 1000 -c 10 http://localhost:5000/api/devices
```

### 测试查询性能
在MongoDB shell中：
```javascript
// 测试地理位置查询性能
db.devices.find({
  location: {
    $near: {
      $geometry: {type: "Point", coordinates: [113.2644, 23.1291]},
      $maxDistance: 1000
    }
  }
}).explain("executionStats")

// 测试聚合查询性能
db.device_logs.aggregate([
  {$match: {log_type: "info"}},
  {$group: {_id: "$device_id", count: {$sum: 1}}}
]).explain("executionStats")
```

## 完成！

如果所有测试都通过，说明系统运行正常，可以开始使用和演示了。


